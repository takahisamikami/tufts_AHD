---
title: "AHD attendance"
author: "Takahisa Mikami"
date: "2022-12-05"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


```{r cars}
if (!require("pacman")) { install.packages("pacman") }
pacman::p_load( pipeR, dplyr, tidyverse, pdftools, tabulizer, data.table, lubridate, knitr, kableExtra, gt )
if (!require("remotes")) { install.packages("remotes") }
```

# Objective
To investigate if there is a specific rotation that always leads to residents being unable to join AHD on time. 

<br>

# Methods
- Attendance reports automatically generated by Zoom were used. 
- Periods: 11/4-12/2 (4 weeks; excluding 11/25 because there was no AHD)

<br>

# Looking at Data 

## Rotation schedule of each resident

Let's look at each resident's schedule between November 4 and December 9. 

```{r Rotation table}
home_path = "/Users/TakahisaMikami/drive/0.NeuroEducation/Tufts_education/AHD/AHD_participants"
df_rotation = openxlsx::read.xlsx(file.path(home_path, "attendance_reports/participants_schedule.xlsx"))
df_rotation %>>% 
  kbl() %>%
  kable_classic_2(c("striped", "hover", "condensed", "responsive"), full_width = F, html_font = "Arial")
  # kable_styling()

```

<br>
<br>
 
## Attendance reports
Below is a sample attendance report for the AHD recording on November 4, which is availble on zoom website.


```{r Attendance reports}
date_list <- c("d1104", "d1111", "d1118", "d1202") # , "d1209"
path_prefix <- paste0(home_path, "/attendance_reports/participants_")
file_list <- paste0(path_prefix, date_list, ".csv") %>>% as.list()

# Take a look at the first 10 rows in the first file 
data.table::fread( file_list[[1]] ) %>>% 
    dplyr::select( name = 1, t_join = 3, t_leave = 4 ) %>>%
  head(10) %>>% 
  # gt()
  kbl() %>%
  kable_classic_2(c("striped", "hover", "condensed", "responsive"), full_width = F, html_font = "Arial")

```
<br>
<br>
 
```{r Creating functions}
# function that identify each resident's name
func_convert_name <- function( df ) {
  df %>>%
    dplyr::mutate( 
      name = case_when(
        str_detect( name, "ikami" ) ~ "Taka", 
        str_detect( name, "Taka" ) ~ "Taka", 
        str_detect( name, "Valeria" ) ~ "Valeria", 
        str_detect( name, "Firas" ) ~ "Firas", 
        str_detect( name, "asaman" ) ~ "Yasaman", 
        str_detect( name, "asmine" ) ~ "Yasaman", 
        str_detect( name, "anizhe" ) ~ "Manizhe", 
        str_detect( name, "amelia" ) ~ "Camelia", 
        str_detect( name, "afail" ) ~ "Rafail",
        str_detect( name, "vanna" ) ~ "Ivanna",
        str_detect( name, "Aya" ) ~ "Aya",
        str_detect( name, "ikita" ) ~ "Nikita",
        str_detect( name, "aby" ) ~ "Gaby",
        str_detect( name, "hsan" ) ~ "Ehsan",
        str_detect( name, "mniyah" ) ~ "Omniyah",
        str_detect( name, "az" ) ~ "Naz",
        str_detect( name, "arc" ) ~ "Marc",
        str_detect( name, "libay" ) ~ "Alibay",
        str_detect( name, "naman" ) ~ "Naman",
        str_detect( name, "Naman" ) ~ "Naman",
        str_detect( name, "enzheng" ) ~ "Wenzheng",
        str_detect( name, "ustafa" ) ~ "Mustafa",
        str_detect( name, "rsalan" ) ~ "Arsalan",
        TRUE ~ name
      )
    ) %>>% 
    dplyr::filter( ! str_detect( name, "Suski|Agosto|Yerstein|PRO|12819396952|16177506418|Yakov|SUNY|OBH|Lerner|Kornbluth|tufts|ivia|Grace|Xuemei|iPhone|Ofori|RESPAR|paulgross" ) ) 
}

# Tidying files; removed overlapped times 
func_ahd_tidy <- function( filename_i ) { 
  # temp_union = 
  data.table::fread( filename_i ) %>>% 
    dplyr::select( name = 1, t_join = 3, t_leave = 4 ) %>>% 
    func_convert_name() %>>% 
    dplyr::mutate( 
      across( c( t_join, t_leave ), ~ lubridate::mdy_hms(.x) )
    ) %>>% 
    group_by(name) %>%
    mutate(indx = c(0, cumsum(as.numeric(lead(t_join)) >
                                cummax(as.numeric(t_leave)))[-n()])) %>%
    group_by(name, indx) %>%
    summarise(t_join = first(t_join), t_leave = last(t_leave)) %>>% 
    dplyr::ungroup() 
}

func_ahd_ModifyEndTime <- function( i ) { 
  df_leave <- df_ahd_list[[i]] %>>% 
    dplyr::group_by( name ) %>>% 
    dplyr::summarise( max_t_leave = max(t_leave) )
  median_t_leave <- median(sort(df_leave$max_t_leave))
  df_ahd_list[[i]] %>>% 
    dplyr::mutate(
      t_leave = if_else( t_leave > median_t_leave, median_t_leave, t_leave ) ) %>>%
    
    dplyr::mutate( interval = time_length(interval(t_join, t_leave), unit = "minutes") ) %>>% 
    dplyr::arrange(name) %>>%
    dplyr::group_by(name) %>>% 
    dplyr::summarise( 
      t_join = min(t_join), 
      t_leave = max(t_leave),
      t_total = sum(interval), 
      n_login = n()
    ) %>>% 
    dplyr::ungroup() %>>% 
    dplyr::mutate(
      join_rate = t_total / max(t_total)
    ) %>>% 
  dplyr::right_join( df_rotation[c("name", "class", date_list[i])], by = "name" ) %>>% 
    dplyr::rename( rotation = ncol(.) ) %>>% 
    dplyr::mutate( across( t_total:join_rate, ~ replace_na( .x, 0 ) ) )
}
```

<br>
<br>
 
## Indexing login data
- removing overlap (e.g., removing the periods when one resident has logged in using two devices)

```{r Participantce reports}
df_ahd_list <- file_list %>>% lapply( func_ahd_tidy )
df_ahd_list[[1]] %>>% 
  kbl() %>%
  kable_classic_2(c("striped", "hover", "condensed", "responsive"), full_width = F, html_font = "Arial")

```

<br>
<br>
 
```{r Total participation time}
df_ahd_tidy <- 
  purrr::map_df( 1:4, func_ahd_ModifyEndTime ) %>>% 
  as.data.frame() %>>% 
  dplyr::arrange( name )

df_ahd_tidy$res_id <- as.factor( match(df_ahd_tidy$name, sample(unique(df_ahd_tidy$name))) )
df_rotation_mean <- df_ahd_tidy %>>% 
  dplyr::group_by(rotation) %>>% 
  dplyr::summarise( rate_mean = mean(join_rate) ) %>>% 
  dplyr::arrange( rate_mean )

df_ahd_tidy <- df_ahd_tidy %>>% 
  dplyr::mutate( 
    rotation = fct_relevel( rotation, df_rotation_mean$rotation ),
    across(t_join:t_leave, ~ format( .x, format = "%H:%M:%S") ),
    d_join = t_join, d_leave = t_leave,
    across(d_join:d_leave, 
      ~ as.integer( as.difftime( hms( .x ) - hms("13H 0M 00S"), units = "secs" ) ) ), 
    across(d_join:d_leave, ~ if_else( !is.na(.x), .x / 60, as.numeric(as.character(.x)) ) ), 
    across(d_join:d_leave, ~ if_else( .x < 0, 0, .x ) ), 
    join_rate = join_rate * 100
    ) 
```



# Results

## Per rotation

Variables:
<br>
__*Participation rate*__
= "(A total time one logged in the AHD) / (median value of the total login time)"

- Black dots indicate mean values for each rotation 

__*Number of login*__
= How many times one had to login/logout during AHD

__*Delay in login*__
= How many minutes after 1pm one joined AHD

<br>

```{r Participation rate for each rotation, echo=FALSE, fig.width=8,fig.height=10}

theme_perrotation <- theme(
    plot.title = element_text(size = 12, hjust = 0, vjust = 3), # , face = "bold"
    legend.position= c(0.82, 0.3), # "top", 
    legend.justification = c(0, .5), 
    panel.background = element_rect(fill = "white"),
    legend.key  = element_rect(colour = "transparent", fill = "white"),
    legend.text = element_text(size=8),
    legend.title = element_text(size=8), 
    legend.key.height = unit(.3, "cm"), 
    axis.text.x = element_text(angle = 45, hjust =1, size = 10), 
    axis.line.x = element_line(colour = "black", size = .5),
    axis.line.y = element_line(colour = "black", size = .5),
    axis.line = element_line(size = 1
    )
  )

df_ahd_tidy_join_rotation <- df_ahd_tidy %>>% 
  dplyr::group_by( rotation ) %>>%
  dplyr::summarise( join_rate = mean(join_rate) ) 
  

g1 <- df_ahd_tidy %>>% 
  ggplot( aes( x = rotation, y = join_rate, color = class ) ) + 
  geom_point( size = 1.5, alpha = 0.8 ) + 
  geom_point(data = df_ahd_tidy_join_rotation, color = "black") +
  labs( 
    title = paste( "Participation rate" ),
    x = "", 
    y = "Participation (%)" ) + 
  labs( colour = "Residents" ) + # shape="", 
  theme_perrotation

g2 <- df_ahd_tidy %>>% 
  # dplyr::mutate( rotation = fct_relevel( rotation, as.vector(df_plot_login$rotation) ) ) %>>%
  dplyr::group_by( rotation ) %>>%
  dplyr::summarise( n_login = mean(n_login) ) %>>% 
  dplyr::arrange( n_login ) %>>%
  ggplot( aes( x = rotation, y = n_login ) ) +
  geom_point( size = 1.5 ) + 
  labs( 
    title = paste( "Number of login" ),
    x = "", 
    y = "Number of login" ) + 
  labs( colour = "Residents" ) + # shape="", 
  theme_perrotation

g3 <- df_ahd_tidy %>>% 
  dplyr::group_by( rotation ) %>>%
  dplyr::summarise( d_join = mean(d_join) ) %>>% 
  ggplot( aes( x = rotation, y = d_join ) ) +
  geom_point( size = 1.5 ) + 
  labs( 
    title = paste( "Delay in login" ),
    x = "Rotation", 
    y = "Delay in login after 1PM (min)" ) + 
  labs( colour = "Residents" ) + # shape="", 
  theme_perrotation


plot_row <- cowplot::plot_grid( g1, g2, g3, nrow = 3,
                                # labels = c( "A: Non-Stroke", "B: Stroke" ),
                                label_fontface = "plain"
                                # label_x = 0.05, label_y = 0.9
                                # rel_heights = c(0.3, 1)
)
plot_row


```
<br>
<br>
 
 
## Per resident


```{r Plots per name, echo=FALSE, fig.width=8,fig.height=8}

df_plot_name <- 
  df_ahd_tidy %>>%
  # dplyr::filter( name == "" ) %>>% 
  dplyr::filter( rotation != "NF" ) %>>% 
  dplyr::group_by( name ) %>>%
  dplyr::summarise( 
    n_login = mean(n_login), 
    join_rate = mean(join_rate, na.rm = T), 
    d_join = mean(d_join, na.rm = T), 
    t_join = hms("13H 0M 00S") + as.period(dminutes( d_join )), 
    d_leave = mean(d_leave, na.rm = T), 
    t_leave = hms("13H 0M 00S") + as.period(dminutes( d_leave )),
    res_id = res_id[1], class = class[1]
    ) 


theme_perrname <- theme(
    plot.title = element_text(size = 12, hjust = 0, vjust = 3), # , face = "bold"
    legend.justification = c(0, .5), 
    panel.background = element_rect(fill = "white"),
    legend.key  = element_rect(colour = "transparent", fill = "white"),
    legend.text = element_text(size=8),
    legend.title = element_text(size=8), 
    legend.key.height = unit(.3, "cm"), 
    axis.text.x = element_text(size = 10), 
    axis.line.x = element_line(colour = "black", size = .5),
    axis.line.y = element_line(colour = "black", size = .5),
    axis.line = element_line(size = 1
    )
  )


plotoptions_name <- list(
  facet_wrap( ~ class, scales = "free" ),
  theme_perrname
)

# Participation rate
p1 <- df_plot_name %>>% 
  dplyr::arrange( join_rate ) %>>% 
  dplyr::mutate( 
    res_id = fct_relevel( res_id, as.character(.$res_id) ),
    ) %>>%  # dplyr::pull(res_id)
  ggplot( aes( x = res_id, y = join_rate, group = class ) ) +
  geom_point( size = 1.5 ) + 
  labs( 
    title = paste( "Participation rate" ),
    x = "", 
    y = "Participation (%)" ) + 
  ylim( 0, 100 ) + 
  plotoptions_name

# Number of login
p2 <- df_plot_name %>>% 
  dplyr::arrange( n_login ) %>>% 
  dplyr::mutate( res_id = fct_relevel( res_id, as.character(.$res_id) ) ) %>>%  # dplyr::pull(res_id)
  ggplot( aes( x = res_id, y = n_login, group = class ) ) +
  geom_point( size = 1.5 ) + 
  labs( 
    title = paste( "Number of login" ),
    x = "", 
    y = "Number of login" ) + 
  ylim( 0, 3 ) + 
  plotoptions_name
  
# Delay in login
p3 <- df_plot_name %>>% 
  dplyr::arrange( d_join ) %>>% 
  dplyr::mutate( res_id = fct_relevel( res_id, as.character(.$res_id) ) ) %>>%  # dplyr::pull(res_id)
  ggplot( aes( x = res_id, y = d_join, group = class ) ) +
  geom_point( size = 1.5 ) + 
  labs( 
    title = paste( "Delay in login" ),
    x = "Resident ID", 
    y = "Delay in login after 1PM (min)" ) + 
  ylim( 0, 60 ) + 
  plotoptions_name

plot_row <- cowplot::plot_grid( p1, p2, p3, nrow = 3,
                                # labels = c( "A: Non-Stroke", "B: Stroke" ),
                                label_fontface = "plain"
                                # label_x = 0.05, label_y = 0.9
                                # rel_heights = c(0.3, 1)
)
plot_row




```


```{r GLM, echo=FALSE, fig.width=8,fig.height=8}

# GENERALIZED ESTIMATING EQUATIONS (GEE) model

# median(df_ahd_tidy$join_rate)
df_ahd_tidy_OR <- df_ahd_tidy %>>% 
  dplyr::mutate( join_low = if_else( join_rate < 80, 1, 0) )

formula_cov <- paste( c( "rotation", "class" ), collapse = "+" )
formula_all <- as.formula( paste( "join_low ~",  formula_cov ) )

glm_model <- geepack::geeglm( 
    formula_all
    , family = binomial( link="logit" )
    , data = df_ahd_tidy_OR
    , id = res_id
)

# OR_tidy <- function( glm_model ){ 
#     
#     bind_cols( 
#         broom::tidy( glm_model, conf.int=F, exponentiate=F ) %>>% 
#             dplyr::mutate( estimate = exp( estimate ) ) %>>% 
#             dplyr::select( term, estimate, p.value ), 
#         exp( broom::confint_tidy( glm_model, func = stats::confint.default ) ) 
#     ) %>>% 
#         dplyr::select( term, estimate, CI95low = conf.low, CI95high = conf.high, pvalue = p.value ) %>>% 
#         dplyr::mutate( across( estimate:CI95high, ~ round(.x, 2 ) ) ) %>>% 
#         dplyr::mutate( p.value = round( pvalue, 4) ) %>>% 
#         
#         filter(term != "(Intercept)") %>>% 
#         dplyr::mutate( 
#             pvalue = if_else( pvalue < 0.001, 
#                               "< 0.001", 
#                               as.character( round( pvalue, digits = 3 ) ) )
#         )  %>>% 
#         
#         dplyr::mutate( CI =  str_glue( '{CI95low}-{CI95high}' ) ) %>>% 
#         dplyr::mutate_at( "CI", function( x ) { gsub(" ", "", x, fixed = TRUE) } ) %>>% 
#         dplyr::mutate( CI = paste0( "(", CI, ")" ) )  %>>% 
#         
#         dplyr::mutate( OR = paste( estimate, CI, sep = " ") ) %>>%
#         dplyr::mutate( outcome = "join_low" ) %>>%
#         dplyr::select( outcome, term, estimate, CI95low, CI95high, OR, pvalue ) 
# }

```

<br>

# Limitation 
Not reflected in the data include: 
* Tufts consult residents logged in but had to continue to work on notes or see pending consult (once)
* Lahey Jr had to go to stroke code just before 1pm, and/or had to leave on 4:30 pm while AHD lasts until 5pm (once)
* Lahey Sr had to do write notes while taking over the pager when Lahey Jr is seeing stroke codes (once)
* Tufts Sr had to do family meeting (once)

